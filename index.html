<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Nh·∫≠t K√Ω T√¨nh Y√™u</title>
    <style>
      body {
        text-align: center;
        background: url("background.png") no-repeat center center/cover;
        color: rgb(155, 124, 124);
        font-family: "Segoe UI", sans-serif;
      }
      h1 {
        font-size: 3em;
        margin-top: 20px;
        animation: fadeIn 3s ease-in-out;
      }
      h2 {
        margin-top: 5px;
      }
      button,
      input,
      textarea {
        font-size: 1em;
        padding: 10px;
        border-radius: 8px;
        border: none;
        margin-top: 5px;
      }
      button {
        background-color: rgba(255, 192, 203, 0.925);
        cursor: pointer;
      }
      textarea {
        width: 90%;
        min-height: 60px;
        resize: vertical;
      }
      #emoji-box {
        display: none;
      }
      #entries {
        margin-top: 20px;
        text-align: left;
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
        background: rgba(255, 255, 255, 0.8);
        padding: 15px;
        border-radius: 10px;
      }
      .heart {
        width: 200px;
        height: 200px;
        margin: 40px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        animation: heartbeat 1s infinite;
      }
      .heart svg {
        width: 100%;
        height: 100%;
      }
      .heart svg path {
        animation: heartbeatColor 1s infinite;
      }
      .number-wrapper {
        position: absolute;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .number {
        font-size: 36px;
        font-weight: bold;
        color: #b22222;
      }
      .label {
        font-size: 16px;
        font-weight: bold;
        color: #b22222;
        margin-top: 4px;
      }

      .falling-heart {
        position: fixed;
        top: -20px;
        color: pink;
        animation: fall linear forwards;
        z-index: 9999;
      }

      .timeline {
        position: relative;
        margin: 20px auto;
        padding: 10px 0;
        max-width: 600px;
        text-align: left;
      }

      .timeline::after {
        content: "";
        position: absolute;
        width: 5px;
        background-color: #ccc;
        top: 10px;
        bottom: 10px;
        left: 21px;
      }

      .timeline-item {
        padding: 20px 20px 20px 60px;
        position: relative;
        border-left: none;
        margin: 0px 0;
      }
      .timeline-item.show {
        opacity: 1;
        transform: translateY(0);
      }

      .timeline-item::before {
        content: "";
        position: absolute;
        top: 22px;
        left: 0px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background-color: pink;
        border: 2px solid #fff;
        z-index: 1;
      }
      .love-letter {
        position: fixed;
        top: -60px;
        font-size: 60px;
        z-index: 10000;
        animation: letterFall linear forwards;
        text-shadow: 0 0 10px pink, 0 0 20px hotpink, 0 0 30px red;
      }
      /* Modal n·ªÅn m·ªù */
      .modal {
        position: fixed;
        z-index: 10000;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 182, 193, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.6s;
      }
      .hidden {
        display: none;
      }

      /* N·ªôi dung modal */
      .modal-content {
        background: #fff0f6;
        border-radius: 18px;
        padding: 25px 35px;
        text-align: center;
        max-width: 500px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        position: relative;
        animation: popUp 0.7s ease;
      }

      .modal-content p {
        font-size: 22px;
        font-style: italic;
        color: #b22222;
        margin-top: 15px;
        line-height: 1.5;
      }

      #quoteText {
        display: inline-block;
        max-width: 90%;
        word-wrap: break-word;
        text-align: center;
      }

       #quoteText::after {
        content: " üíï";
        font-size: 24px;
        color: #ff4d6d;
        animation: heartbeat 1.5s infinite;
      }

      /* N√∫t ƒë√≥ng */
      .close {
        position: absolute;
        top: 12px;
        right: 18px;
        font-size: 30px;
        font-weight: bold;
        color: #d63384;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .close:hover {
        transform: scale(1.2);
      }
      .reactions {
        margin-top: 10px;
        display: flex;
        gap: 10px;
      }

      .react-btn {
        background: #ffe0e6;
        border: none;
        padding: 5px 10px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: transform 0.2s;
      }

      .react-btn:hover {
        transform: scale(1.2);
      }

      /* Hi·ªáu ·ª©ng */
      @keyframes popUp {
        0% {
          transform: scale(0.7);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      @keyframes fall {
        to {
          transform: translateY(100vh);
          opacity: 0;
        }
      }
      @keyframes letterFall {
        0% {
          transform: translateX(0) translateY(0) rotate(0deg);
          opacity: 1;
        }
        25% {
          transform: translateX(-30px) translateY(25vh) rotate(90deg);
        }
        50% {
          transform: translateX(30px) translateY(50vh) rotate(180deg);
        }
        75% {
          transform: translateX(-30px) translateY(75vh) rotate(270deg);
        }
        100% {
          transform: translateX(0) translateY(100vh) rotate(360deg);
          opacity: 0;
        }
      }
      @keyframes heartbeat {
        0%,
        100% {
          transform: scale(1);
        }
        25% {
          transform: scale(1.1);
        }
        50% {
          transform: scale(0.95);
        }
        75% {
          transform: scale(1.05);
        }
      }
      @keyframes heartbeatColor {
        0%,
        100% {
          fill: rgb(255, 192, 203);
        }
        50% {
          fill: rgb(247, 170, 182);
        }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <!-- <audio id="bg-music" loop>
      <source src="I Do.mp3" type="audio/mpeg" />
    </audio> -->

    <h1>üéâ Nh·ª©t Hu·ª≥nh & B·∫£o Ng·ªçc üéâ</h1>
    <h2>üìñ Nh·∫≠t K√Ω Anh & B√© üìñ</h2>

    <!-- ƒê·∫øm ng√†y y√™u -->
    <div class="heart">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 
             2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09
             C13.09 3.81 14.76 3 16.5 3 
             19.58 3 22 5.42 22 8.5
             c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
          fill="pink"
        />
      </svg>
      <div class="number-wrapper">
        <div class="number" id="loveDays">0</div>
        <div class="label">DAYS</div>
      </div>
    </div>
    <!-- Modal Quote -->
    <div id="quoteModal" class="modal hidden">
      <div class="modal-content">
        <span id="closeModal" class="close">&times;</span>
        <p id="quoteText"></p>
      </div>
    </div>

    <h3>‚úèÔ∏è Vi·∫øt nh·∫≠t k√Ω m·ªõi</h3>
    <textarea id="textInput" placeholder="Nh·∫≠p n·ªôi dung..."></textarea><br />
    <input type="date" id="unlockDateInput">
    <button onclick="displayEmojiBox()">Emoji</button>
    <center><emoji-picker id="emoji-box"></emoji-picker></center>
    <br />
    <input type="file" id="fileInput" accept="image/*,video/*" /><br />
    <button onclick="addEntry()">ƒêƒÉng nh·∫≠t k√Ω</button>

    <div id="entries" class="timeline"></div>

    <script type="module">
      import "https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js";
      document.addEventListener("DOMContentLoaded", () => {
        const picker = document.querySelector("emoji-picker");
        const textarea = document.querySelector("#textInput");
        picker.addEventListener("emoji-click", (event) => {
          textarea.value += event.detail.unicode;
        });
      });
    </script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
    <script>
      // ======= Firebase Config =======
      const firebaseConfig = {
        apiKey: "AIzaSyBsumPv8_hk16RcR-mwrx4UVbt8XMzi_2c",
        authDomain: "love-diary-69c00.firebaseapp.com",
        projectId: "love-diary-69c00",
        storageBucket: "love-diary-69c00.appspot.com",
        messagingSenderId: "299225297515",
        appId: "1:299225297515:web:dda7bcb35a0c8ae95af72e",
        measurementId: "G-213TXQLVFX",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      function displayEmojiBox() {
        const box = document.getElementById("emoji-box");
        box.style.display =
          box.style.display === "none" || box.style.display === ""
            ? "block"
            : "none";
      }

      // // ƒê·∫øm ng∆∞·ª£c (b·∫°n c√≥ th·ªÉ b·∫≠t l·∫°i n·∫øu mu·ªën)
      // function countdownDays() {
      //   const meetDate = new Date("2028-08-17");
      //   const now = new Date();
      //   return Math.ceil((meetDate - now) / (1000 * 60 * 60 * 24));
      // }

      // Nh·∫°c n·ªÅn
      const music = document.getElementById("bg-music");
      document.addEventListener("click", function playOnce() {
        music.play();
        document.removeEventListener("click", playOnce);
      });

      // T√≠nh s·ªë ng√†y y√™u
      function calculateLoveDays() {
        const startDate = new Date("2024-03-27");
        const today = new Date();
        const diffTime = Math.abs(today - startDate);
        return Math.floor(diffTime / (1000 * 60 * 60 * 24));
      }

      function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        let startTimestamp = null;
        const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          obj.innerText = Math.floor(progress * (end - start) + start);
          if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
      }

      // ================== CLOUDINARY ==================
      async function uploadToCloudinary(file) {
        const url = "https://api.cloudinary.com/v1_1/dlpy17slx/auto/upload";
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", "LoveDiary");

        const res = await fetch(url, { method: "POST", body: formData });
        const data = await res.json();
        return { url: data.secure_url, type: file.type };
      }

      // ================== NH·∫¨T K√ù ==================
      function loadEntries() {
  db.collection("entries")
    .orderBy("date", "desc")
    .onSnapshot((snapshot) => {
      const entriesDiv = document.getElementById("entries");
      if (!entriesDiv) return;
      entriesDiv.innerHTML = "";

      const now = Date.now();
      

      snapshot.forEach((doc) => {
        const entry = doc.data();

        // üëâ ki·ªÉm tra ng√†y m·ªü (unlockDate)
        if (entry.unlockDate && entry.unlockDate > now) {
          const lockedDiv = document.createElement("div");
          lockedDiv.classList.add("timeline-item");
          lockedDiv.innerHTML = `
            <strong>${new Date(entry.date).toLocaleString("vi-VN")}</strong><br>
            <em>üîí B√†i vi·∫øt s·∫Ω ƒë∆∞·ª£c m·ªü v√†o: ${new Date(entry.unlockDate).toLocaleDateString("vi-VN")}</em>
          `;
          entriesDiv.appendChild(lockedDiv);
          return; // üëâ ch∆∞a m·ªü th√¨ kh√¥ng render n·ªôi dung
        }

        // üëâ render b√†i ƒë√£ m·ªü
        const div = document.createElement("div");
        div.classList.add("timeline-item");

        let content = `<strong>${new Date(entry.date).toLocaleString("vi-VN")}</strong><br>`;
        if (entry.text) content += `${entry.text}<br>`;
        if (entry.fileUrl) {
          if (entry.fileType.startsWith("image/")) {
            content += `<img src="${entry.fileUrl}" style="max-width:100%; margin-top:10px;">`;
          } else if (entry.fileType.startsWith("video/")) {
            content += `<video controls style="max-width:100%; margin-top:10px;">
                          <source src="${entry.fileUrl}" type="${entry.fileType}">
                        </video>`;
          }
        }

        // üëâ th√™m n√∫t Edit v√† Delete
        content += `
          <div style="margin-top:10px;">
            <button onclick="editEntry('${doc.id}', '${entry.text ? entry.text.replace(/'/g,"\\'") : ""}')">‚úèÔ∏è</button>
            <button onclick="deleteEntry('${doc.id}')">üóëÔ∏è</button>
          </div>
        `;

        div.innerHTML = content;
        entriesDiv.appendChild(div);

        // üëâ render reactions n·∫øu c√≥
        renderReactions(div, doc.id, entry.reactions || {});
      });
    });
}


      async function addEntry() {
        const text = document.getElementById("textInput").value.trim();
        const file = document.getElementById("fileInput").files[0];
        const dateNow = Date.now();
        const unlockDateInput = document.getElementById("unlockDateInput").value;
        const unlockDate = unlockDateInput ? new Date(unlockDateInput).getTime() : Date.now();
        if (!text && !file) {
          alert("Vui l√≤ng nh·∫≠p n·ªôi dung ho·∫∑c ch·ªçn file!");
          return;
        }

        let fileUrl = "",
          fileType = "";
        if (file) {
          const uploaded = await uploadToCloudinary(file);
          fileUrl = uploaded.url;
          fileType = uploaded.type;
        }

        await db.collection("entries").add({
          text: text || "",
          fileUrl: fileUrl || "",
          fileType: fileType || "",
          date: dateNow,
          unlockDate: unlockDate,
        });

        document.getElementById("textInput").value = "";
        document.getElementById("fileInput").value = "";

        // üíå G·ªçi hi·ªáu ·ª©ng r∆°i nhi·ªÅu l√° th∆∞
        for (let i = 0; i < 5; i++) {
          setTimeout(dropLetter, i * 300);
        }
      }

      /*async function deleteEntry(id) {
        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y kh√¥ng?")) {
          await db.collection("entries").doc(id).delete();
          alert("ƒê√£ x√≥a th√†nh c√¥ng!");
        }
      }*/

      async function editEntry(id, oldText) {
        const newText = prompt("Nh·∫≠p n·ªôi dung m·ªõi:", oldText);
        if (newText !== null) {
          await db.collection("entries").doc(id).update({
            text: newText,
          });
          alert("ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!");
        }
      }

      window.onload = () => {
        loadEntries();
        const days = calculateLoveDays();
        animateValue("loveDays", 0, days, 2000);
        showQuoteOfTheDay();
      };

      //================= animation heart ============
      function createFallingHeart() {
        const heart = document.createElement("div");
        heart.classList.add("falling-heart");
        heart.innerText = "‚ù§Ô∏è";

        // V·ªã tr√≠ ng·∫´u nhi√™n ngang m√†n h√¨nh
        heart.style.left = Math.random() * window.innerWidth + "px";

        // K√≠ch th∆∞·ªõc ng·∫´u nhi√™n
        const size = Math.random() * 20 + 15;
        heart.style.fontSize = size + "px";

        // Th·ªùi gian r∆°i ng·∫´u nhi√™n
        const duration = Math.random() * 3 + 4;
        heart.style.animationDuration = duration + "s";

        document.body.appendChild(heart);

        // Xo√° khi k·∫øt th√∫c animation
        setTimeout(() => {
          heart.remove();
        }, duration * 1000);
      }

      // T·∫°o tim li√™n t·ª•c m·ªói 300ms
      setInterval(createFallingHeart, 300);

      // =========== QUOTE M·ªñI NG√ÄY  ==========
      async function showQuoteOfTheDay() {
        try {
          // 1. L·∫•y t·∫•t c·∫£ quotes t·ª´ Firestore
          const quotesSnapshot = await db.collection("quotes").get();
          const quotes = [];
          quotesSnapshot.forEach((doc) => quotes.push(doc.data().text));

          if (quotes.length === 0) {
            alert("Ch∆∞a c√≥ quote n√†o üíå");
            return;
          }

          // 2. T√≠nh s·ªë ng√†y & s·ªë tu·∫ßn t·ª´ Epoch
          const today = new Date();
          const daysSinceEpoch = Math.floor(
            today.getTime() / (1000 * 60 * 60 * 24)
          );
          const weekNumber = Math.floor(daysSinceEpoch / 7);
          const dayOfWeek = today.getDay();

          // 3. Sinh s·ªë "ng·∫´u nhi√™n ·ªïn ƒë·ªãnh" d·ª±a tr√™n tu·∫ßn + ng√†y
          function seededRandom(seed) {
            let x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
          }

          const seed = weekNumber * 7 + dayOfWeek;
          const index = Math.floor(seededRandom(seed) * quotes.length);

          const chosen = quotes[index];

          // 4. Hi·ªÉn th·ªã
          openQuoteModal(chosen);
        } catch (error) {
          console.error("L·ªói khi load quote:", error);
          alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c quote üò¢");
        }
      }
      function openQuoteModal(text) {
        document.getElementById("quoteText").textContent = text;
        document.getElementById("quoteModal").classList.remove("hidden");
      }
      function closeQuoteModal() {
        document.getElementById("quoteModal").classList.add("hidden");
      }
      document.getElementById("closeModal").onclick = closeQuoteModal;
      window.onclick = (e) => {
        if (e.target === document.getElementById("quoteModal")) {
          closeQuoteModal();
        }
      };
      //=========== Animation button upload -> l√° th∆∞ ==================
      function dropLetter() {
        const letter = document.createElement("div");
        letter.classList.add("love-letter");
        letter.textContent = "üíå";

        // v·ªã tr√≠ ng·∫´u nhi√™n
        letter.style.left = Math.random() * window.innerWidth + "px";

        // k√≠ch th∆∞·ªõc ng·∫´u nhi√™n
        const size = Math.random() * 15 + 25;
        letter.style.fontSize = size + "px";

        // th·ªùi gian r∆°i ng·∫´u nhi√™n
        const duration = Math.random() * 2 + 3; // 3s - 5s
        letter.style.animationDuration = duration + "s";

        document.body.appendChild(letter);

        setTimeout(() => {
          letter.remove();
        }, duration * 1000);
      }

      //  T·∫°o m∆∞a th∆∞ t√¨nh
      function dropManyLetters() {
        let count = 0;
        let interval = setInterval(() => {
          dropLetter();
          count++;
          if (count >= 30) {
            // t·ªïng s·ªë l√° th∆∞ mu·ªën r∆°i
            clearInterval(interval);
          }
        }, 150);
      }
      // ===== Observer ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng xu·∫•t hi·ªán m∆∞·ª£t =====
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("show");
              observer.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.2 }
      );
      //================Reaction=================
      function renderReactions(entryDiv, entryId, reactions) {
        const reactionsDiv = document.createElement("div");
        reactionsDiv.classList.add("reactions");

        ["‚ù§Ô∏è", "üòÇ", "üòò", "ü•π", "üò†", "üòÜ", "üòí", "üòÆ"].forEach((emoji) => {
          const btn = document.createElement("button");
          btn.classList.add("react-btn");
          btn.dataset.type = emoji;
          btn.innerHTML = `${emoji} <span class="count">${
            reactions[emoji] || 0
          }</span>`;

          btn.addEventListener("click", async () => {
            const entryRef = db.collection("entries").doc(entryId);
            const docSnap = await entryRef.get();
            const currentReactions = docSnap.data().reactions || {};
            currentReactions[emoji] = (currentReactions[emoji] || 0) + 1;
            await entryRef.update({ reactions: currentReactions });
          });

          reactionsDiv.appendChild(btn);
        });

        entryDiv.appendChild(reactionsDiv);
      }
    </script>
  </body>
</html>
