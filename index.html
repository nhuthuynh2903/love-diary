<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Nh·∫≠t K√Ω & Sinh Nh·∫≠t B√© B·∫£o Ng·ªçc</title>
    <style>
      body {
        text-align: center;
        background: url("background.png") no-repeat center center/cover;
        color: rgb(155, 124, 124);
        font-family: "Segoe UI", sans-serif;
      }
      h1 {
        font-size: 3em;
        margin-top: 20px;
        animation: fadeIn 3s ease-in-out;
      }
      h2 {
        margin-top: 5px;
      }
      button,
      input,
      textarea {
        font-size: 1em;
        padding: 10px;
        border-radius: 8px;
        border: none;
        margin-top: 5px;
      }
      button {
        background-color: rgba(255, 192, 203, 0.925);
        cursor: pointer;
      }
      textarea {
        width: 90%;
        min-height: 60px;
        resize: vertical;
      }
      #entries {
        margin-top: 20px;
        text-align: left;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
        background: rgba(255, 255, 255, 0.8);
        padding: 15px;
        border-radius: 10px;
      }
      .entry {
        padding: 10px;
        border-bottom: 1px solid #ccc;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <audio id="bg-music" loop>
      <source src="I Do.mp3" type="audio/mpeg" />
    </audio>

    <h1>üéâ Happy Birthday B√© B·∫£o Ng·ªçc üéâ</h1>
    <h2>üìñ Nh·∫≠t K√Ω Anh & B√© üìñ</h2>

    <p>Nh·∫•n v√†o n√∫t b√™n d∆∞·ªõi ƒë·ªÉ xem l·ªùi ch√∫c üíå</p>
    <button onclick="showMessage()">M·ªü b·∫•t ng·ªù</button>
    <p id="message" style="display: none; font-size: 1.2em"></p>

    <h3>‚úèÔ∏è Vi·∫øt nh·∫≠t k√Ω m·ªõi</h3>
    <textarea id="textInput" placeholder="Nh·∫≠p n·ªôi dung..."></textarea><br />
    <input type="file" id="fileInput" accept="image/*,video/*" /><br />
    <button onclick="addEntry()">ƒêƒÉng nh·∫≠t k√Ω</button>

    <div id="entries"></div>

    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
    <script>
      // ======= Firebase Config =======
      const firebaseConfig = {
        apiKey: "AIzaSyBsumPv8_hk16RcR-mwrx4UVbt8XMzi_2c",
        authDomain: "love-diary-69c00.firebaseapp.com",
        projectId: "love-diary-69c00",
        storageBucket: "love-diary-69c00.appspot.com",
        messagingSenderId: "299225297515",
        appId: "1:299225297515:web:dda7bcb35a0c8ae95af72e",
        measurementId: "G-213TXQLVFX",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Hi·ªÉn th·ªã l·ªùi ch√∫c
      function showMessage() {
        document.getElementById("message").innerHTML =
          "üéÇüíñ Ch√∫c m·ª´ng sinh nh·∫≠t b√© iu üíñ, anh iu b√© nh√¨u üíñüíñ " +
          "Sinh nh·∫≠t th·ª© 2 v·ªõi b√© √≤ii üíñ, t·ª´ng gi√¢y ph√∫t b√™n nhau üíñ h∆°n m·ªôt nƒÉm qua anh r·∫•t vui üíñ. " +
          "C√≥ th·ªÉ √≠t nh·∫•t l√† 3 nƒÉm t·ªõi üíñ anh s·∫Ω kh√¥ng th·ªÉ b√™n c·∫°nh b√© üíñ trong ng√†y sinh nh·∫≠t ƒë∆∞·ª£c n·ªØa üíñ, nh∆∞ng b√© h√£y y√™n t√¢m üíñ v√† ch·ªù anh nhoaa üíñ. " +
          "ƒêi r·ªìi üíªüíñ luy·ªán tr√¨nh code chung v·ªõi b√© n√® üíñ, l√¢u l√¢u c√≥ ƒëi ƒë√¢u ch∆°i üé°üíñ c√≥ g√¨ vui th√¨ up l√™n trang web n√†y üì∏üíñ chia s·∫ª cho nhau nha üíñ. " +
          "H·∫πn g·∫∑p em üíñ trong " +
          countdownDays() +
          " ng√†y n·ªØa! (c√≥ th·ªÉ thay ƒë·ªïi)";
        document.getElementById("message").style.display = "block";
      }

      // ƒê·∫øm ng∆∞·ª£c
      function countdownDays() {
        const meetDate = new Date("2028-08-17");
        const now = new Date();
        return Math.ceil((meetDate - now) / (1000 * 60 * 60 * 24));
      }

      // Nh·∫°c n·ªÅn
      const music = document.getElementById("bg-music");
      document.addEventListener("click", function playOnce() {
        music.play();
        document.removeEventListener("click", playOnce);
      });

      // ================== CLOUDINARY ==================
      async function uploadToCloudinary(file) {
        const url = "https://api.cloudinary.com/v1_1/dlpy17slx/auto/upload";
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", "LoveDiary"); // t·∫°o preset trong Cloudinary Dashboard

        const res = await fetch(url, {
          method: "POST",
          body: formData,
        });
        const data = await res.json();
        return { url: data.secure_url, type: file.type };
      }

      // ================== NH·∫¨T K√ù ==================
      // Load realtime entries
      function loadEntries() {
        db.collection("entries")
          .orderBy("date", "desc")
          .onSnapshot((snapshot) => {
            const entriesDiv = document.getElementById("entries");
            if (!entriesDiv) return;
            entriesDiv.innerHTML = "";

            snapshot.forEach((doc) => {
              const entry = doc.data();
              const div = document.createElement("div");
              div.classList.add("entry");

              let content = `<strong>${new Date(entry.date).toLocaleString(
                "vi-VN"
              )}</strong><br>`;

              if (entry.text) {
                content += `${entry.text}<br>`;
              }
              if (entry.fileUrl) {
                if (entry.fileType.startsWith("image/")) {
                  content += `<img src="${entry.fileUrl}" style="max-width: 100%; margin-top: 10px;">`;
                } else if (entry.fileType.startsWith("video/")) {
                  content += `<video controls style="max-width: 100%; margin-top: 10px;">
                                <source src="${entry.fileUrl}" type="${entry.fileType}">
                              </video>`;
                }
              }

              div.innerHTML = content;
              entriesDiv.appendChild(div);
            });
          });
      }

      // Th√™m nh·∫≠t k√Ω
      async function addEntry() {
        const text = document.getElementById("textInput").value.trim();
        const file = document.getElementById("fileInput").files[0];
        const dateNow = Date.now();

        if (!text && !file) {
          alert("Vui l√≤ng nh·∫≠p n·ªôi dung ho·∫∑c ch·ªçn file!");
          return;
        }

        let fileUrl = "";
        let fileType = "";

        if (file) {
          const uploaded = await uploadToCloudinary(file);
          fileUrl = uploaded.url;
          fileType = uploaded.type;
        }

        await db.collection("entries").add({
          text: text || "",
          fileUrl: fileUrl || "",
          fileType: fileType || "",
          date: dateNow,
        });

        document.getElementById("textInput").value = "";
        document.getElementById("fileInput").value = "";
      }

      window.onload = loadEntries;
    </script>
  </body>
</html>
